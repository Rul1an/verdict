Metadata-Version: 2.4
Name: verdict-sdk
Version: 0.3.0
Summary: Python SDK for Verdict - Deterministic Regression Gating
Author-email: Verdict <hello@verdict.dev>
License-Expression: MIT
Requires-Python: >=3.8
Provides-Extra: dev
Requires-Dist: black; extra == 'dev'
Requires-Dist: isort; extra == 'dev'
Requires-Dist: mypy; extra == 'dev'
Requires-Dist: pytest; extra == 'dev'
Requires-Dist: pytest-asyncio; extra == 'dev'
Provides-Extra: openai
Requires-Dist: openai>=1.0.0; extra == 'openai'
Description-Content-Type: text/markdown

# Verdict Python SDK

**Record deterministic traces from your Python agents for regression gating.**

## üöÄ Golden Quickstart

The fastest way to regression test your AI agent.

### 1. Install
```bash
pip install "verdict-sdk[openai]"
```

### 2. Record (`record.py`)
Run your agent through the SDK to capture a trace. Pass your tool functions to `tool_executors` so Verdict can record their inputs and outputs.

```python
import os
import openai
from verdict_sdk import TraceWriter, record_chat_completions_with_tools

# 1. Setup Client & Tools
client = openai.OpenAI(api_key=os.environ.get("OPENAI_API_KEY", "mock"))
TOOLS = [{
    "type": "function",
    "function": {
        "name": "GetWeather",
        "parameters": {"type": "object", "properties": {"location": {"type": "string"}}}
    }
}]

# 2. Define Execution Logic (The "Real" Code)
def get_weather(args):
    return {"temp": 22, "location": args.get("location")}

# 3. Record the Loop
writer = TraceWriter("traces/quickstart.jsonl")
result = record_chat_completions_with_tools(
    writer=writer,
    client=client,
    model="gpt-4o",
    messages=[{"role": "user", "content": "Weather in Tokyo?"}],
    tools=TOOLS,
    tool_executors={"GetWeather": get_weather}, # Link schema -> function
    episode_id="weather_demo",
    test_id="weather_check"
)
print(f"Agent Final Answer: {result['content']}")
```

### 3. Configure (`verdict.yaml`)
Tell Verdict what to check.

```yaml
version: 1
model: "trace"
tests:
  - id: weather_check
    input:
      prompt: "Weather in Tokyo?" # Matches the recorded prompt
    expected:
      type: regex_match
      pattern: ".*" # Pass if any content returned (baseline check)
```

### 4. Verify
Run the regression gate. This replays your trace against the recorded tool outputs to ensure determinism.

```bash
# Verify strictly (fails if any tool call arg changed even slightly)
verdict ci --config verdict.yaml --trace-file traces/quickstart.jsonl --replay-strict --db :memory:
```

---

## üåä Advanced: Streaming support
Capture streaming responses while maintaining tool call execution.

```python
from verdict_sdk import record_chat_completions_stream_with_tools

# ... setup client & writer ...

result = record_chat_completions_with_tools(
    writer=writer,
    # ... args ...
    stream=True # SDK handles chunk aggregation automatically
)
```
*Note: The hybrid wrapper (`record_chat_completions_stream_with_tools`) streams the thinking tokens to the user, executes tools, and then performs a standard follow-up call.*

## üõ°Ô∏è Advanced: Privacy & Redaction
Protect sensitive data (PII, API keys) from ever hitting the trace file.

```python
from verdict_sdk import TraceWriter, make_redactor

# Create a redactor that scrubs keys and regex patterns
redactor = make_redactor(
    key_denylist={"authorization", "password", "api_key"},
    patterns=[r"sk-[a-zA-Z0-9]{20,}"] # Mask OpenAI keys
)

# Attach to writer - happens automatically on write
writer = TraceWriter("traces/secure.jsonl", redact_fn=redactor)
```

## ‚ö° Async Support
*(Coming Soon in Phase 1.4.1)* - Native `async` support for high-throughput applications (FastAPI, etc.).

## ‚ùì Troubleshooting

### `E_TRACE_EPISODE_MISSING`
**Cause**: The `test_id` or `episode_id` in your trace doesn't match what `verdict ci` expected from its config (or implicit default).
**Fix**: Ensure your `verdict.yaml` test IDs match the `test_id` passed to `record_chat_completions...`.

### "Duplicate prompt in strict replay"
**Cause**: You ran `record.py` twice without cleaning the trace file, so it contains two identical episodes. `verdict ci` in strict mode doesn't know which one to replay.
**Fix**:
1. Truncate the file before recording: `writer = TraceWriter("...", mode="w")` (if supported) or file `open(..., 'w').close()`.
2. Use unique `episode_id`s (e.g. UUIDs) for every run.
