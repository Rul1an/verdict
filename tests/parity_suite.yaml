# Parity Test Suite
#
# Verifies that batch mode and streaming mode produce identical results.
# This is the canonical test set for the "one engine, two modes" guarantee.
#
# Usage:
#   assay parity-test --suite tests/parity_suite.yaml
#
# Any divergence between batch and streaming is a RELEASE BLOCKER.

configVersion: 1
suite: parity-verification

metadata:
  description: "Batch vs Streaming parity verification"
  version: "1.0.0"
  criticality: blocker

# ============================================================
# ARGS_VALID PARITY TESTS
# ============================================================

tests:
  # --- Pass cases ---
  
  - id: args_valid_pass_basic
    description: "Valid args within constraints"
    check_type: args_valid
    policy:
      schema:
        type: object
        properties:
          percent:
            type: number
            maximum: 30
          reason:
            type: string
            minLength: 5
        required: [percent, reason]
    input:
      tool_name: ApplyDiscount
      args:
        percent: 15
        reason: "Loyalty program discount"
    expected:
      outcome: pass
      parity: must_match

  - id: args_valid_pass_at_boundary
    description: "Args exactly at maximum boundary"
    check_type: args_valid
    policy:
      schema:
        properties:
          percent:
            maximum: 30
        required: [percent]
    input:
      tool_name: ApplyDiscount
      args:
        percent: 30
    expected:
      outcome: pass
      parity: must_match

  - id: args_valid_pass_optional_missing
    description: "Optional field not provided"
    check_type: args_valid
    policy:
      schema:
        properties:
          required_field:
            type: string
          optional_field:
            type: number
        required: [required_field]
    input:
      tool_name: TestTool
      args:
        required_field: "present"
    expected:
      outcome: pass
      parity: must_match

  # --- Fail cases ---

  - id: args_valid_fail_exceeds_max
    description: "Percent exceeds maximum"
    check_type: args_valid
    policy:
      schema:
        properties:
          percent:
            maximum: 30
        required: [percent]
    input:
      tool_name: ApplyDiscount
      args:
        percent: 50
    expected:
      outcome: fail
      reason_contains: "exceeds maximum"
      parity: must_match

  - id: args_valid_fail_missing_required
    description: "Required field missing"
    check_type: args_valid
    policy:
      schema:
        properties:
          percent:
            type: number
          reason:
            type: string
        required: [percent, reason]
    input:
      tool_name: ApplyDiscount
      args:
        percent: 10
        # reason is missing
    expected:
      outcome: fail
      reason_contains: "missing required"
      parity: must_match

  # --- Error cases ---

  - id: args_valid_error_no_args
    description: "No args provided"
    check_type: args_valid
    policy:
      schema:
        properties:
          anything:
            type: string
    input:
      tool_name: TestTool
      args: null
    expected:
      outcome: error
      reason_contains: "No args"
      parity: must_match

# ============================================================
# SEQUENCE_VALID PARITY TESTS
# ============================================================

  # --- Pass cases ---

  - id: sequence_pass_correct_order
    description: "Tools called in correct order"
    check_type: sequence_valid
    policy:
      rules:
        - type: require
          tool: VerifyIdentity
        - type: before
          first: VerifyIdentity
          then: DeleteAccount
    input:
      trace:
        - tool_name: VerifyIdentity
          args: {}
          timestamp_ms: 1000
        - tool_name: ConfirmAction
          args: {}
          timestamp_ms: 2000
        - tool_name: DeleteAccount
          args: {}
          timestamp_ms: 3000
    expected:
      outcome: pass
      parity: must_match

  - id: sequence_pass_extra_tools
    description: "Extra tools between required ones"
    check_type: sequence_valid
    policy:
      rules:
        - type: before
          first: Start
          then: End
    input:
      trace:
        - tool_name: Start
          args: {}
          timestamp_ms: 1000
        - tool_name: Middle1
          args: {}
          timestamp_ms: 2000
        - tool_name: Middle2
          args: {}
          timestamp_ms: 3000
        - tool_name: End
          args: {}
          timestamp_ms: 4000
    expected:
      outcome: pass
      parity: must_match

  # --- Fail cases ---

  - id: sequence_fail_missing_required
    description: "Required tool not called"
    check_type: sequence_valid
    policy:
      rules:
        - type: require
          tool: VerifyIdentity
    input:
      trace:
        - tool_name: DeleteAccount
          args: {}
          timestamp_ms: 1000
    expected:
      outcome: fail
      reason_contains: "required tool not called"
      parity: must_match

  - id: sequence_fail_wrong_order
    description: "Tools called in wrong order"
    check_type: sequence_valid
    policy:
      rules:
        - type: require
          tool: VerifyIdentity
        - type: before
          first: VerifyIdentity
          then: DeleteAccount
    input:
      trace:
        - tool_name: DeleteAccount
          args: {}
          timestamp_ms: 1000
        - tool_name: VerifyIdentity
          args: {}
          timestamp_ms: 2000
    expected:
      outcome: fail
      reason_contains: "must come before"
      parity: must_match

  # --- Error cases ---

  - id: sequence_error_no_trace
    description: "No trace provided"
    check_type: sequence_valid
    policy:
      rules:
        - type: require
          tool: Anything
    input:
      trace: null
    expected:
      outcome: error
      reason_contains: "No trace"
      parity: must_match

# ============================================================
# TOOL_BLOCKLIST PARITY TESTS
# ============================================================

  # --- Pass cases ---

  - id: blocklist_pass_allowed_tool
    description: "Tool not on blocklist"
    check_type: tool_blocklist
    policy:
      blocked:
        - DeleteDatabase
        - DropTable
        - ExecuteRawSQL
    input:
      tool_name: SelectQuery
    expected:
      outcome: pass
      parity: must_match

  - id: blocklist_pass_similar_name
    description: "Similar but not identical tool name"
    check_type: tool_blocklist
    policy:
      blocked:
        - DeleteDatabase
    input:
      tool_name: DeleteDatabaseBackup  # Different tool
    expected:
      outcome: pass
      parity: must_match

  # --- Fail cases ---

  - id: blocklist_fail_exact_match
    description: "Exact match on blocklist"
    check_type: tool_blocklist
    policy:
      blocked:
        - DeleteDatabase
        - DropTable
    input:
      tool_name: DeleteDatabase
    expected:
      outcome: fail
      reason_contains: "is blocked"
      parity: must_match

  - id: blocklist_fail_another_blocked
    description: "Another tool on blocklist"
    check_type: tool_blocklist
    policy:
      blocked:
        - DeleteDatabase
        - DropTable
        - ExecuteRawSQL
    input:
      tool_name: ExecuteRawSQL
    expected:
      outcome: fail
      reason_contains: "is blocked"
      parity: must_match

  # --- Error cases ---

  - id: blocklist_error_no_tool
    description: "No tool name provided"
    check_type: tool_blocklist
    policy:
      blocked:
        - Anything
    input:
      tool_name: null
    expected:
      outcome: error
      reason_contains: "No tool_name"
      parity: must_match

# ============================================================
# EDGE CASES
# ============================================================

  - id: edge_empty_blocklist
    description: "Empty blocklist allows all"
    check_type: tool_blocklist
    policy:
      blocked: []
    input:
      tool_name: AnythingGoes
    expected:
      outcome: pass
      parity: must_match

  - id: edge_unicode_tool_name
    description: "Unicode in tool name"
    check_type: tool_blocklist
    policy:
      blocked:
        - 削除ツール
    input:
      tool_name: 削除ツール
    expected:
      outcome: fail
      parity: must_match

  - id: edge_special_chars_in_args
    description: "Special characters in arguments"
    check_type: args_valid
    policy:
      schema:
        properties:
          query:
            type: string
    input:
      tool_name: Search
      args:
        query: "SELECT * FROM users; DROP TABLE users;--"
    expected:
      outcome: pass  # Schema doesn't restrict content
      parity: must_match

  - id: edge_null_in_args
    description: "Null value in args object"
    check_type: args_valid
    policy:
      schema:
        properties:
          optional:
            type: string
    input:
      tool_name: Test
      args:
        optional: null
    expected:
      outcome: pass
      parity: must_match

# ============================================================
# SUMMARY
# ============================================================
#
# Total tests: 20
# - args_valid: 6
# - sequence_valid: 5
# - tool_blocklist: 5
# - edge cases: 4
#
# All tests must pass with parity: must_match
# Any divergence is a v1.0 release blocker.
